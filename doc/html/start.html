
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Getting started &mdash; Clacks Project</title>
    
    <link rel="stylesheet" href="_static/clacks.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/cindex.css" type="text/css" />
    <link rel="stylesheet" href="_static/requirements.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.8',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Clacks Project" href="index.html" />
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Neuton&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Nobile:regular,italic,bold,bolditalic&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

  </head>
  <body>
<script src="_static/jquery.msCarousel-min.js"></script>
<link rel="stylesheet" type="text/css" href="_static/mscarousel.css" />

    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right"><form class="search" style="display:inline" action="search.html" method="get">
  <input type="text" name="q" placeholder="Type your search..."/>
  <input type="submit" value="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
<script type="text/javascript">$('#searchbox').show(0);</script></li>
        <li class="right"><a href="http://oss.gonicus.de">Issues</a>  |</li>
        <li class="right"><a href="downloads.html">Download</a>  |</li>
        <li class="right"><a href="doc_index.html">Documentation</a>  |</li>
        <li class="right"><a href="start.html">Getting started</a>  |</li>
        <li><a href="index.html">Clacks Project</a> &raquo;</li> 
      </ul>
    </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="body">
          
  <div class="section" id="getting-started">
<span id="quickstart"></span><h1>Getting started<a class="headerlink" href="#getting-started" title="Permalink to this headline">¶</a></h1>
<p>This document contains information on <em>how to get started</em> with
the Clacks framework. It covers package based installations (Debian/Ubuntu),
package less installtions and the common tasks that are needed to
operate an agent.</p>
<div class="section" id="common-prerequisites">
<h2>Common prerequisites<a class="headerlink" href="#common-prerequisites" title="Permalink to this headline">¶</a></h2>
<p>The Clacks framework is a piece of software that has certain dependencies: it
communicates using the AMQP protocol and stores its information in directory
services or databases. These services - and their authentication - need to
be properly orchestrated to form a valid Clacks domain.</p>
<p>This section explains how to setup an AMQP broker, a LDAP server and optionally
shows how to tweak a DNS for service discovery in networks where local service
discovery is not sufficient.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In this guide all services run on the same host - which is not mandatory.</p>
</div>
<p>It also covers the configuration of SASL to get the AMQP broker to authenticate
with the LDAP service and helps to configure the AMQP authorization to avoid
malicious use of AMQP queues.</p>
<div class="section" id="choosing-a-domain">
<h3>Choosing a domain<a class="headerlink" href="#choosing-a-domain" title="Permalink to this headline">¶</a></h3>
<p>The first step - however - is to choose a domain where Clacks should operate
on. It is recommended to use a reversed form of the DNS domain name that is
valid for your current setup.</p>
<p>If you&#8217;re operating in <strong>example.net</strong>, the Clacks domain should be <strong>net.example</strong>.
This reverse domain notation is used for determining access to certain objects
and makes it more easy to grant access to sub domains like <strong>foo.example.net</strong> later
on.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You&#8217;re not forced to use this reversed notation, but you&#8217;re encouraged to
do so in setups that may be nested later on.</p>
</div>
</div>
<div class="section" id="choosing-a-hostname">
<h3>Choosing a hostname<a class="headerlink" href="#choosing-a-hostname" title="Permalink to this headline">¶</a></h3>
<p>Be sure that your current hostname is the one you&#8217;re going to use later on
and that <em>hostname</em> returns different output than <em>hostname -f</em>: hostname
alone should not return the fully quallified domain name.</p>
<p>Below, we use <strong>agent</strong> for the Clacks agent hostname and <strong>client</strong> for the
Clacks client hostname.</p>
</div>
<div class="section" id="service-discovery">
<span id="setting-up-dns"></span><h3>Service discovery<a class="headerlink" href="#service-discovery" title="Permalink to this headline">¶</a></h3>
<p>Clacks uses the zeroconf protocol to find its counterparts by default. While
this works fine in local networks (like your test setup that you&#8217;re using
to get started), this may lead to problems when your network is split to
several physical zones and routing of the discovery packages doesn&#8217;t seam
reasonable.</p>
<p>If this is the case for you, you should configure your site DNS to allow
static zeroconf DNS service discovery.</p>
<p>Here is an example for the example.net domain:</p>
<div class="highlight-python"><pre>; Zeroconf base setup
b._dns-sd._udp                  PTR @   ;  b = browse domain
lb._dns-sd._udp                 PTR @   ;  lb = legacy browse domain
_services._dns-sd._udp          PTR _amqps._tcp
                                PTR _https._tcp

; Zeroconf clacks records
_amqps._tcp                     PTR Clacks\ RPC\ Service._amqps._tcp
Clacks\ RPC\ Service._amqps._tcp  SRV 0 0 5671 agent.example.net.
                                TXT path=/net.example service=clacks

_https._tcp                     PTR Clacks\ Web\ Service._https._tcp
                                PTR Clacks\ RPC\ Service._https._tcp
Clacks\ Web\ Service._https._tcp  SRV 0 0 443 agent.example.net.
                                TXT path=/admin/index.html
Clacks\ RPC\ Service._https._tcp SRV 0 0 8080 agent.example.net.
                                TXT path=/rpc service=clacks</pre>
</div>
<p>This will add static service discovery entries for an agent with the
hostname <em>agent.example.net</em>.</p>
<p>After reloading your DNS, you may test your setup with:</p>
<div class="highlight-python"><pre>you@agent:~$ avahi-browse -D
+  n/a  n/a example.net

you@agent:~$ avahi-browse -rd example.net _amqps._tcp
+   k.A. k.A. Clacks RPC Service                              _amqps._tcp          example.net
=   k.A. k.A. Clacks RPC Service                              _amqps._tcp          example.net
   hostname = [agent.example.net]
   address = [10.3.64.59]
   port = [5671]
   txt = ["service=clacks" "path=/net.example"]</pre>
</div>
</div>
<div class="section" id="installing-mongodb">
<span id="setting-up-mongo"></span><h3>Installing MongoDB<a class="headerlink" href="#installing-mongodb" title="Permalink to this headline">¶</a></h3>
<p>The Clacks framework maintains an index of all objects of its one. The reason for
this is that you can combine several backends like LDAP, JSON, Opsi, SQL, etc. to
assemble a single object. Searching in all backends is expensive and uses the
local index.</p>
<p>Indexing is done with MongoDB which needs a basic, local install for the simpliest
case:</p>
<div class="highlight-python"><pre>$ sudo apt-get install mongodb-server</pre>
</div>
<p>Unless you&#8217;re not doing bigger replicated setups, you should be fine with this.
Note that mongodb doesn&#8217;t use authentication in this basic installation. Be sure
that you&#8217;ve at least restricted the access to <em>localhost</em> via</p>
<blockquote>
<div>::
bind_ip = 127.0.0.1</div></blockquote>
<p>in your <em>/etc/mongodb.conf</em>.</p>
</div>
<div class="section" id="installing-an-amqp-service">
<span id="setting-up-amqp"></span><h3>Installing an AMQP service<a class="headerlink" href="#installing-an-amqp-service" title="Permalink to this headline">¶</a></h3>
<p>Clacks uses AMQP as a messaging service. It will not work without it. Several
used AMQP features lead to the requirement that Qpid needs to be used as
an AMQP message broker. Your distribution should have one for you:</p>
<div class="highlight-python"><pre>$ sudo apt-get install qpidd qpid-client qpid-tools</pre>
</div>
<p>After qpid has been installed, you may modify the access policy
to fit the clacks-agent needs. A starting point could be a
<cite>/etc/qpid/qpidd.acl</cite> containing:</p>
<div class="highlight-python"><pre># Group definitions
group admins admin@QPID
group agents agent@QPID
group event-consumer agent@QPID
group event-publisher agent@QPID

# Admin is allowed to do everything
acl allow admins all

# Reply queue handling
acl allow all access exchange name=reply-*
acl allow all access queue name=reply-* owner=self
acl allow all create queue name=reply-* durable=false autodelete=true
acl allow all consume queue name=reply-* owner=self
acl allow all publish exchange routingkey=reply-* owner=self

# Event producer
acl allow event-publisher all     queue    name=net.example
acl allow event-publisher all     exchange name=net.example

# Event consumer
acl allow all create  queue    name=event-listener-*
acl allow all delete  queue    name=event-listener-* owner=self
acl allow all consume queue    name=event-listener-* owner=self
acl allow all access  queue    name=event-listener-* owner=self
acl allow all purge   queue    name=event-listener-* owner=self
acl allow all access  queue    name=net.example
acl allow all access  exchange name=net.example
acl allow all access  exchange name=event-listener-* owner=self
acl allow all bind    exchange name=net.example queuename=event-listener-* routingkey=event
acl allow all unbind  exchange name=net.example queuename=event-listener-* routingkey=event
acl allow all publish exchange name=net.example routingkey=event

# Let agents do everything with the net.example queues and exchanges, agents itself
# are trusted by now.
acl allow agents all queue name=net.example.*
acl allow agents all exchange name=net.example.*
acl allow agents all exchange name=amq.direct queuename=net.example.*

# Let every authenticated instance publish to the command queues
acl allow all access   queue    name=net.example.command.*
acl allow all publish  queue    name=net.example.command.*
acl allow all publish  exchange routingkey=net.example.command.*
acl allow all access   exchange name=net.example.command.*

# Let clients create their own queue to listen on
acl allow all access  queue    name=net.example
acl allow all access  queue    name=net.example.client.* owner=self
acl allow all consume queue    name=net.example.client.* owner=self
acl allow all create  queue    name=net.example.client.* exclusive=true autodelete=true durable=false
acl allow all access  exchange name=net.example
acl allow all access  exchange name=net.example.client.* owner=self
acl allow all bind    exchange name=amq.direct queuename=net.example.client.*

# Let agents send to the client queues
acl allow agents publish  exchange  routingkey=net.example.client.*

# By default, drop everything else
acl deny all all</pre>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Remember that you&#8217;ve to adjust the domain from <em>net.example</em> to whatever you&#8217;ve
choosen in the beginning. Same for <em>agent</em> which is the hostname of your Clacks
agent and <em>admin</em> which is the <em>cn</em> of your LDAP administrator.</p>
</div>
<p>For production use, you should enable SSL for the AMQP broker. Generating the certificates
is shown here:</p>
<p><a class="reference external" href="http://rajith.2rlabs.com/2010/03/01/apache-qpid-securing-connections-with-ssl/">http://rajith.2rlabs.com/2010/03/01/apache-qpid-securing-connections-with-ssl/</a></p>
</div>
<div class="section" id="installing-the-ldap-service">
<span id="setting-up-ldap"></span><h3>Installing the LDAP service<a class="headerlink" href="#installing-the-ldap-service" title="Permalink to this headline">¶</a></h3>
<p>In the base setup you need to setup an LDAP server. It contains the very basic
structure you&#8217;re going to mainain with Clacks. Your distribution has LDAP packages
for sure. We&#8217;re using OpenLDAP in this case:</p>
<div class="highlight-python"><pre>$ sudo DEBIAN_PRIORITY=low apt-get install slapd ldap-utils</pre>
</div>
<p>Select a base and the administrative credentials. Memorize these values, because
you&#8217;ll need them later on.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In this document we&#8217;ll use the domain-component style for your current
domain. I.e. <strong>dc=example,dc=net</strong> is the base. <strong>cn=admin,dc=example,dc=net</strong> is
the administrative DN.</p>
</div>
<p>Clacks itself does not require to install an additional LDAP schema. Nearly.
Except if you plan to use Clacks <em>clients</em>.</p>
<p>To use the client mechanisms, a couple of schema files have to be added to
your configuration. The following text assumes that you&#8217;ve a plain / empty
stock debian configuration on your system. If it&#8217;s not the case, you&#8217;ve to
know what to do yourself.</p>
<p>First, install the provided schema files. These commands have to be executed
with <em>root</em> power by default, so feel free to use sudo and find the schema
<em>LDIF</em> files in the <tt class="docutils literal"><span class="pre">contrib/ldap</span></tt> directory of your clacks document
directory. Install these schema files like this:</p>
<div class="highlight-python"><pre>$ sudo ldapadd -Y EXTERNAL -H ldapi:/// -f registered-device.ldif
$ sudo ldapadd -Y EXTERNAL -H ldapi:/// -f installed-device.ldif
$ sudo ldapadd -Y EXTERNAL -H ldapi:/// -f configured-device.ldif</pre>
</div>
<p>After you&#8217;ve done that, find out which base is configured for your system:</p>
<div class="highlight-python"><pre>$ sudo ldapsearch -LLL -Y EXTERNAL -H ldapi:/// -b cn=config olcSuffix=* olcSuffix
SASL/EXTERNAL authentication started
SASL username: gidNumber=0+uidNumber=0,cn=peercred,cn=external,cn=auth
SASL SSF: 0
dn: olcDatabase={1}hdb,cn=config
olcSuffix: dc=example,dc=net</pre>
</div>
<p>In this case, you&#8217;ll see the configured suffix as <strong>dc=example,dc=net</strong> in the
result set. Your milieage may vary.</p>
<p>Based on the suffix, create a <em>LDIF</em> file containing an updated index - on top with
the <em>DN</em> shown in the result of the search above:</p>
<div class="highlight-python"><pre>dn: olcDatabase={1}hdb,cn=config
changetype: modify
replace: olcDbIndex
olcDbIndex: default sub
olcDbIndex: objectClass pres,eq
olcDbIndex: cn pres,eq,sub
olcDbIndex: uid eq,sub
olcDbIndex: uidNumber eq
olcDbIndex: gidNumber eq
olcDbIndex: mail eq,sub
olcDbIndex: deviceStatus pres,sub
olcDbIndex: deviceType pres,eq
olcDbIndex: sn pres,eq,sub
olcDbIndex: givenName pres,eq,sub
olcDbIndex: ou pres,eq,sub
olcDbIndex: memberUid eq
olcDbIndex: uniqueMember eq
olcDbIndex: deviceUUID pres,eq</pre>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">If you have not installed the Clacks device schema files, you have to skip the
attributes <em>deviceUUID</em>, <em>deviceStatus</em> and <em>deviceType</em> in the index list.</p>
</div>
<p>Save that file to <em>index-update.ldif</em> and add it to your LDAP using:</p>
<div class="highlight-python"><pre>$ sudo ldapmodify -Y EXTERNAL -H ldapi:/// -f index-update.ldif</pre>
</div>
<p>Your LDAP now has the required schema files and an updated index to perform
searches in reliable speed.</p>
<p>The agent itself needs an entry inside that LDAP that is used to authenticate
to the AMQP service. Create this entry - again inside an LDIF file like this:</p>
<div class="highlight-python"><pre>dn: cn=agent,dc=example,dc=net
objectClass: simpleSecurityObject
objectClass: organizationalRole
cn: agent
userPassword: secret</pre>
</div>
<p>Save that file to <em>agent.ldif</em> and apply it to your LDAP using:</p>
<div class="highlight-python"><pre>$ sudo ldapmodify -Y EXTERNAL -H ldapi:/// -f agent.ldif</pre>
</div>
<p>The password is unencrypted in the moment, that can be changed using:</p>
<div class="highlight-python"><pre>$ sudo ldappasswd -Y EXTERNAL -H ldapi:/// cn=agent,dc=example,dc=net</pre>
</div>
<p>Change the password to the one you like and memorize it for use with the
Clacks agent configuration below.</p>
</div>
<div class="section" id="amqp-ldap-authentication">
<span id="setting-up-ldap-auth"></span><h3>AMQP LDAP-Authentication<a class="headerlink" href="#amqp-ldap-authentication" title="Permalink to this headline">¶</a></h3>
<p>Qpid is not LDAP enabled by default, but it supports everything supported
by SASL thru the <em>saslauthd</em>. To install <em>saslauthd</em> run:</p>
<div class="highlight-python"><pre>$ sudo apt-get install sasl2-bin</pre>
</div>
<p>The daemon is not started by default. To configure it to start up automatically
and to use LDAP for it&#8217;s authentication source, edit the file /etc/default/saslauthd
like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#</span>
<span class="c"># Settings for saslauthd daemon</span>
<span class="c"># Please read /usr/share/doc/sasl2-bin/README.Debian for details.</span>
<span class="c">#</span>

<span class="c"># Should saslauthd run automatically on startup? (default: no)</span>
<span class="n">START</span><span class="o">=</span><span class="n">yes</span>

<span class="c"># Description of this saslauthd instance. Recommended.</span>
<span class="c"># (suggestion: SASL Authentication Daemon)</span>
<span class="n">DESC</span><span class="o">=</span><span class="s">&quot;SASL Authentication Daemon&quot;</span>

<span class="c"># Short name of this saslauthd instance. Strongly recommended.</span>
<span class="c"># (suggestion: saslauthd)</span>
<span class="n">NAME</span><span class="o">=</span><span class="s">&quot;saslauthd&quot;</span>

<span class="c"># Which authentication mechanisms should saslauthd use? (default: pam)</span>
<span class="c">#</span>
<span class="c"># Available options in this Debian package:</span>
<span class="c"># getpwent  -- use the getpwent() library function</span>
<span class="c"># kerberos5 -- use Kerberos 5</span>
<span class="c"># pam       -- use PAM</span>
<span class="c"># rimap     -- use a remote IMAP server</span>
<span class="c"># shadow    -- use the local shadow password file</span>
<span class="c"># sasldb    -- use the local sasldb database file</span>
<span class="c"># ldap      -- use LDAP (configuration is in /etc/saslauthd.conf)</span>
<span class="c">#</span>
<span class="c"># Only one option may be used at a time. See the saslauthd man page</span>
<span class="c"># for more information.</span>
<span class="c">#</span>
<span class="c"># Example: MECHANISMS=&quot;pam&quot;</span>
<span class="n">MECHANISMS</span><span class="o">=</span><span class="s">&quot;ldap&quot;</span>

<span class="c"># Additional options for this mechanism. (default: none)</span>
<span class="c"># See the saslauthd man page for information about mech-specific options.</span>
<span class="n">MECH_OPTIONS</span><span class="o">=</span><span class="s">&quot;&quot;</span>

<span class="c"># How many saslauthd processes should we run? (default: 5)</span>
<span class="c"># A value of 0 will fork a new process for each connection.</span>
<span class="n">THREADS</span><span class="o">=</span><span class="mi">5</span>

<span class="c"># Other options (default: -c -m /var/run/saslauthd)</span>
<span class="c"># Note: You MUST specify the -m option or saslauthd won&#39;t run!</span>
<span class="c">#</span>
<span class="c"># WARNING: DO NOT SPECIFY THE -d OPTION.</span>
<span class="c"># The -d option will cause saslauthd to run in the foreground instead of as</span>
<span class="c"># a daemon. This will PREVENT YOUR SYSTEM FROM BOOTING PROPERLY. If you wish</span>
<span class="c"># to run saslauthd in debug mode, please run it by hand to be safe.</span>
<span class="c">#</span>
<span class="c"># See /usr/share/doc/sasl2-bin/README.Debian for Debian-specific information.</span>
<span class="c"># See the saslauthd man page and the output of &#39;saslauthd -h&#39; for general</span>
<span class="c"># information about these options.</span>
<span class="c">#</span>
<span class="c"># Example for postfix users: &quot;-c -m /var/spool/postfix/var/run/saslauthd&quot;</span>
<span class="n">OPTIONS</span><span class="o">=</span><span class="s">&quot;-c -m /var/run/saslauthd&quot;</span>
</pre></div>
</div>
<p>Additionally, you&#8217;ve to set up the LDAP configuration for <em>saslauthd</em> in the
configuration file <em>/etc/saslauthd.conf</em>:</p>
<div class="highlight-python"><pre>ldap_servers: ldap://agent.example.net
ldap_search_base: dc=example,dc=net
ldap_filter: (|(&amp;(objectClass=simpleSecurityObject)(cn=%U))(&amp;(objectClass=inetOrgPerson)(uid=%U))(&amp;(objectClass=registeredDevice)(deviceUUID=%U)))
ldap_scope: sub
ldap_size_limit: 0
ldap_time_limit: 15
ldap_timeout: 15
ldap_version: 3
ldap_debug: 255</pre>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You may need to adjust the list of LDAP servers and the search base
according to your setup.</p>
</div>
<p>If you have <strong>not</strong> installed the Clacks device schema files, you have to skip the
search for <em>registeredDevice</em> and the search filter should look like this:</p>
<div class="highlight-python"><pre>ldap_filter: (|(&amp;(objectClass=simpleSecurityObject)(cn=%U))(&amp;(objectClass=inetOrgPerson)(uid=%U)))</pre>
</div>
<p>Start the service and test it:</p>
<div class="highlight-python"><pre>$ sudo service saslauthd start
$ sudo testsaslauthd -u agent -p secret -r QPID</pre>
</div>
<p>If that works pretty well, connect the Qpid SASL mechaism to <em>saslauthd</em> by editing
<em>/etc/qpid/sasl/qpidd.conf</em> like this:</p>
<div class="highlight-python"><pre>pwcheck_method: saslauthd
mech_list: PLAIN LOGIN</pre>
</div>
<p>To let Qpid access the <em>saslauthd</em> socket, it needs to be added to the <em>sasl</em> group and the
service needs to be restarted:</p>
<div class="highlight-python"><pre>$ sudo adduser qpidd sasl
$ sudo service qpidd restart</pre>
</div>
<p>Check if it works like supposed to:</p>
<div class="highlight-python"><pre>$ qpid-config -a admin/secret@hostname queues</pre>
</div>
<p>The command should list a few queues that are defined by default.</p>
</div>
</div>
<div class="section" id="using-pre-built-packages">
<h2>Using pre-built packages<a class="headerlink" href="#using-pre-built-packages" title="Permalink to this headline">¶</a></h2>
<p>Currently there are only Debian/Ubuntu packages available for the Clacks
framework. Additionally you need at least Wheezy/12.04 to proceed.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Older versions of Debian/Ubuntu do not have the required package versions
installed. Installations may work using backports and/or re-building</p>
</div>
<div class="section" id="apt-repository">
<h3>APT repository<a class="headerlink" href="#apt-repository" title="Permalink to this headline">¶</a></h3>
<p>Please create a new file under /etc/apt/sources.list.d/clacks.list and place
the following content inside:</p>
<div class="highlight-python"><pre>deb http://debian.gonicus.de/debian wheezy Clacks stable</pre>
</div>
<p>Now install the key package:</p>
<div class="highlight-python"><pre>$ sudo apt-get install gonicus-keyring</pre>
</div>
<p>The installer will report an untrusted package - which is ok in this case,
because it <em>contains</em> the GONICUS signing key. It is used to sign the packages
we&#8217;ll download in the next step.</p>
</div>
<div class="section" id="installing-a-clacks-agent">
<h3>Installing a Clacks agent<a class="headerlink" href="#installing-a-clacks-agent" title="Permalink to this headline">¶</a></h3>
<p>To use the Clacks framework, you need at least one agent that loads some
plugins and provides the base communication framework. Compared to the
client and the shell, the agent is the part that needs most supplying
services.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Until we reach version 1.0, you can only use one agent.</p>
</div>
<p>For the first node, install <em>QPID</em>, <em>LDAP</em> and <em>MongoDB</em>:</p>
<div class="highlight-python"><pre>$ sudo apt-get install mongodb-server slapd ldap-utils sasl2-bin</pre>
</div>
<p>Memorize the user and passwords you&#8217;ve used for LDAP. MongoDB is just
fine and can be configured to only run locally for now.</p>
<p>To proceed, you have to perform the actions detailed in:</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference internal" href="#setting-up-dns"><em>Service discovery</em></a></li>
<li><a class="reference internal" href="#setting-up-ldap"><em>Installing the LDAP service</em></a></li>
<li><a class="reference internal" href="#setting-up-amqp"><em>Installing an AMQP service</em></a></li>
<li><a class="reference internal" href="#setting-up-ldap-auth"><em>AMQP LDAP-Authentication</em></a></li>
</ul>
</div></blockquote>
<p>If this is fine, copy over the configuration file for the Clacks agent to
/etc/clacks/config and adapt the settings to match the ones for your site:</p>
<div class="highlight-python"><pre>$ sudo install -o root -g clacks -m 0640 /usr/share/doc/clacks-agent/examples/config /etc/clacks/config
$ sudo vi /etc/clacks/config</pre>
</div>
<p>At least adapt the node-name to fit the current host name of your server
and the LDAP credentials that you&#8217;ve created in <strong>Setting up LDAP</strong>.</p>
<p>No you can start the agent using:</p>
<div class="highlight-python"><pre>$ sudo supervisorctl start clacks-agent</pre>
</div>
<p>Watch out for errors in <em>/var/log/clacks.log</em>. If everything went up well,
the agent starts indexing your LDAP and you might see some warnings about
not recognized objects.</p>
<p>After the agent is up and running, you should define a couple of ACL sets
in order to get rid of the initial ACL override in your Clacks configuration.</p>
<p>Please take a look at <a class="reference internal" href="#setting-up-acl"><em>Configuring access control</em></a>.</p>
</div>
<div class="section" id="installing-a-clacks-client">
<h3>Installing a Clacks client<a class="headerlink" href="#installing-a-clacks-client" title="Permalink to this headline">¶</a></h3>
<p>Clacks clients are nodes that you want to have <em>under the hood</em> in some form. They
are monitored, inventorized using fusioninventory (optionally) and can be controlled
in various ways. Controlling addresses topics like <em>config management</em> (i.e. using puppet),
<em>system states</em> (reboot, wake on lan, etc.), user notifications and executing certain
commands as <strong>root</strong> on these systems.</p>
<p>To install the client you need to work thru two steps. First, install it (the
example includes the inventory part):</p>
<div class="highlight-python"><pre>$ sudo apt-get install clacks-client fusioninventory-agent</pre>
</div>
<p>The client tries to start, but will fail due to missing configurations, so the
second step is to generate a configuration - aka <em>joining</em> the client to the
Clacks domain. May sound familiar to Microsoft users.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">In the current version, it is only possible to do an <em>active</em> join. The former
GOsa client <em>incoming</em> mechanism is currently beeing implemented and not usable
right now.</p>
</div>
<p>Joining is easy:</p>
<div class="highlight-python"><pre>$ sudo clacks-join</pre>
</div>
<p>It will first search for an active agent. Then you&#8217;ll have to provide the credentials
of a user that is allowed to join the client (i.e. the administrator you&#8217;ve initially
created).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Maybe the zeroconf mechanism that is used to find an agent is not working
in your setup. In this case use the <em>&#8211;url</em> switch to provide the complete
AMQP URL. Example:</p>
<div class="last highlight-python"><pre>$ sudo clacks-join --url amqps://agent.example.net/net.example</pre>
</div>
</div>
<p>If this succeeds, a configuration file is created automatically and you can start the
client:</p>
<div class="highlight-python"><pre>$ sudo supervisorctl start clacks-client</pre>
</div>
<p>If everything went fine, the client is up and running. You&#8217;ll see some messages
in the agent&#8217;s log and the client log for that. As for servers, messages find their
way to <em>/var/log/clacks.log</em>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Joining requires at least one active agent.</p>
</div>
<p>Note that while it is technically no problem to run both - a client and an agent &#8211; on the
same physical node, it is not supported by the packages in the moment.</p>
</div>
<div class="section" id="installing-the-shell">
<h3>Installing the shell<a class="headerlink" href="#installing-the-shell" title="Permalink to this headline">¶</a></h3>
<p>Compared to agents and clients, the shell installation is trivial:</p>
<div class="highlight-python"><pre>$ sudo apt-get install clacks-shell</pre>
</div>
<p>Just try to run it:</p>
<div class="highlight-python"><pre>$ clacksh
Searching service provider...
Connected to https://amqp.example.net:8080/rpc
Username [cajus]:
Password:
Clacks infrastructure shell. Use Ctrl+D to exit.
&gt;&gt;&gt; clacks.help()
...</pre>
</div>
<p>HIER&#8212;-&gt;</p>
</div>
</div>
<div class="section" id="without-pre-built-packages">
<h2>Without pre-built packages<a class="headerlink" href="#without-pre-built-packages" title="Permalink to this headline">¶</a></h2>
<div class="section" id="common-setup">
<h3>Common setup<a class="headerlink" href="#common-setup" title="Permalink to this headline">¶</a></h3>
<div class="section" id="system-prerequisites">
<h4>System prerequisites<a class="headerlink" href="#system-prerequisites" title="Permalink to this headline">¶</a></h4>
<p>To run the services in the designed way later on, you need a special user
and a couple of directories:</p>
<div class="highlight-python"><pre>$ sudo adduser --system --group clacks --home=/var/lib/clacks</pre>
</div>
<p>If you&#8217;re going to run the service in daemon mode, please take care that
there&#8217;s a <em>/var/run/clacks</em> for placing the PID files.</p>
</div>
<div class="section" id="python-prerequisites">
<h4>Python prerequisites<a class="headerlink" href="#python-prerequisites" title="Permalink to this headline">¶</a></h4>
<p>While we try to keep everything inside a virtual python environment for
development, some of the python modules need compilation - which rises the
number of required packages drastically. For the time being, please install
the following packages in your system:</p>
<div class="highlight-python"><pre>$ sudo apt-get install python2.7-dev python-dumbnet python-avahi python-virtualenv \
       libavahi-compat-libdnssd-dev python-openssl python-dbus libssl-dev python-gtk2 \
       python-lxml python-libxml2 python-dmidecode python-ldap python-nose \
       python-kid python-coverage python-dateutil python-smbpasswd python-netifaces \
       sasl2-bin python-cjson</pre>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">On MS Windows systems, only the client is supposed to work. Please install the
pywin32 package: <a class="reference external" href="http://sourceforge.net/projects/pywin32/">http://sourceforge.net/projects/pywin32/</a></p>
</div>
</div>
<div class="section" id="setup-a-virtual-environment-for-playing-with-clacks">
<h4>Setup a virtual environment for playing with clacks<a class="headerlink" href="#setup-a-virtual-environment-for-playing-with-clacks" title="Permalink to this headline">¶</a></h4>
<p>As a non-root user, initialize the virtual environment:</p>
<div class="highlight-python"><pre>$ virtualenv --setuptools --system-site-packages --python=python2.7  clacks
$ cd clacks
$ source bin/activate</pre>
</div>
</div>
<div class="section" id="obtaining-the-source">
<h4>Obtaining the source<a class="headerlink" href="#obtaining-the-source" title="Permalink to this headline">¶</a></h4>
<p>For now, please use git:</p>
<div class="highlight-python"><pre>$ cd 'the place where you created the clacks virtualenv'
$ git clone git://oss.gonicus.de/git/gosa.git src</pre>
</div>
<p>Additionally, you can get some stripped of Clacks 2.7 sources from here:</p>
<div class="highlight-python"><pre>$ git clone git://oss.gonicus.de/git/gosa-gui.git
$ cd gosa-gui
$ git submodule init
$ git submodule update</pre>
</div>
<p>This will place all relevant files inside the &#8216;src&#8217; directory.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The &#8220;source bin/activate&#8221; has to be done every time you work in or with the
virtual environment. Stuff will fail if you don&#8217;t do this. If you&#8217;re asked for
sudo/root, you&#8217;re doing something wrong.</p>
</div>
</div>
</div>
<div class="section" id="id1">
<h3>Installing a Clacks agent<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>To run the agent, you most likely need a working AMQP broker and
a working LDAP setup.</p>
<p>To proceed, you have to perform the actions detailed in:</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference internal" href="#setting-up-dns"><em>Service discovery</em></a></li>
<li><a class="reference internal" href="#setting-up-ldap"><em>Installing the LDAP service</em></a></li>
<li><a class="reference internal" href="#setting-up-amqp"><em>Installing an AMQP service</em></a></li>
<li><a class="reference internal" href="#setting-up-ldap-auth"><em>AMQP LDAP-Authentication</em></a></li>
</ul>
</div></blockquote>
<div class="section" id="deploy-a-development-agent">
<h4>Deploy a development agent<a class="headerlink" href="#deploy-a-development-agent" title="Permalink to this headline">¶</a></h4>
<p>To deploy the agent, please run these commands inside the activated
virtual environment:</p>
<div class="highlight-python"><pre>$ pushd .; cd clacks.common &amp;&amp; ./setup.py develop; popd
$ pushd .; cd clacks.agent &amp;&amp; ./setup.py develop; popd


Alternatively you can build the complete package using::

$ ./setup.py develop</pre>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Using the above command to build the complete package will also build
additional modules like libinst, amires, ...</p>
<p class="last">This will increase the configuration effort drastically, which is not
recommended during the quickstart quide.</p>
</div>
</div>
<div class="section" id="starting-the-service">
<h4>Starting the service<a class="headerlink" href="#starting-the-service" title="Permalink to this headline">¶</a></h4>
<p>In a productive environment, everything should be defined in the configuration
file, so copy the configuration file to the place where clacks expects it:</p>
<div class="highlight-python"><pre>$ mkdir -p /etc/clacks
$ cp ./src/clacks.agent/src/clacks/agent/data/agent.conf /etc/clacks/config</pre>
</div>
<p>Now take a look at the config file and adapt it to your needs.</p>
<p>You can start the daemon in foreground like this:</p>
<div class="highlight-python"><pre>$ clacks-agent</pre>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Make sure, you&#8217;ve entered the virtual environment using &#8220;source bin/activate&#8221;
from inside the clacks directory.</p>
</div>
<p>If you want to run the agent in a more productive manner, you can use the
daemon mode and start it as root. It will then fork to the configured user
and run as a daemon.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">status:</th><td class="field-body">todo
Describe how to secure the communication between the clacks-agent and used services.</td>
</tr>
</tbody>
</table>
<p>Here is an example config file for a non-secured service. (A HowTo about securing the service will follow soon!):</p>
<div class="highlight-python"><pre>[core]

# Keyword loglevel: ALL/DEBUG, INFO, WARNING, ERROR, CRITICAL
loglevel = DEBUG

# Keyword syslog: file, stderr, syslog
log = stderr

# Keyword logfile: full path to log to if log = file
#logfile = /var/log/clacks/agent.log

# Keyword id: name of this clacks-agent node
id = clacks-agent

# Keyword user: username to run the daemon as
#user = clacks

# Keyword group: groupname to run the daemon as
#group = clacks

# Keyword pidfile: where to place the pid in daemon mode
#pidfile = /var/run/clacks/clacks.pid

# Keyword profile: for debugging, only
profile = False

[scheduler]
database = sqlite://

[amqp]

# Keyword url: URL to one of your AMQP servers
#
# Examples:
#
# amqp://amqp.example.net:5671
# amqps://amqp.example.net:5671
#
# Secured services listing on 5672!
# This example uses an unsecured amqp service
url = amqp://localhost:5672

# Keyword id:
id = admin
key = tester

[http]
host = localhost
port = 8080
#sslpemfile = /etc/clacks/host.pem

[goto]
oui-db = /usr/share/clacks/oui.txt

[repository]
database = mysql+mysqldb://libinst:secret@localhost/libinst?charset=utf8&amp;use_unicode=0
http_base_url = http://localhost/debian
db_purge = False
path = /srv/repository/data

[ldap]
url = ldap://localhost/dc=example,dc=net
bind_dn = cn=admin,dc=example,dc=net
bind_secret = secret
pool_size = 10</pre>
</div>
</div>
</div>
<div class="section" id="installing-a-clacks-shell">
<h3>Installing a Clacks shell<a class="headerlink" href="#installing-a-clacks-shell" title="Permalink to this headline">¶</a></h3>
<div class="section" id="installing">
<h4>Installing<a class="headerlink" href="#installing" title="Permalink to this headline">¶</a></h4>
<p>To deploy the shell, use:</p>
<div class="highlight-python"><pre>$ pushd .; cd clacks.common &amp;&amp; ./setup.py develop; popd
$ pushd .; cd clacks.shell &amp;&amp; ./setup.py develop; popd</pre>
</div>
<p>inside your activated virtual env. You can skip this if you ran ./setup.py for
a complete deployment.</p>
</div>
<div class="section" id="first-steps">
<h4>First steps<a class="headerlink" href="#first-steps" title="Permalink to this headline">¶</a></h4>
<p>The clacks shell will use zeroconf/DNS to find relevant connection methods. Alternatively
you can specify the connection URL to skip zeroconf/DNS.</p>
<p>Start the shell and send a command:</p>
<div class="highlight-python"><pre>$ clacksh
(authenticate as the admin user you've created in qpid's SASL DB)
&gt;&gt;&gt; clacks.help()
&gt;&gt;&gt; mksmbhash("secret")
&gt;&gt;&gt; &lt;Strg+D&gt;</pre>
</div>
<p>The shell did not get priorized work in the moment, so the clacks.help() output is
neither sorted, nor grouped by plugins. Much space for improvements.</p>
<p>If you tend to use a connection URL directly, use:</p>
<div class="highlight-python"><pre>$ clacksh http[s]://amqp.example.com:8080/rpc</pre>
</div>
<p>for HTTP based sessions or</p>
<div class="highlight-python"><pre>$ clacksh amqp[s]://amqp.example.com/org.clacks</pre>
</div>
<p>for AMQP based sessions.</p>
</div>
</div>
<div class="section" id="id2">
<h3>Installing a Clacks client<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>A clacks client is a device instance that has been joined into the clacks network.
Every client can incorporate functionality into the network - or can just be
a managed client.</p>
<div class="section" id="id3">
<h4>Installing<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>To deploy the client components, use:</p>
<div class="highlight-python"><pre>$ pushd .; cd clacks.common &amp;&amp; ./setup.py develop; popd
$ pushd .; cd clacks.client &amp;&amp; ./setup.py develop; popd
$ pushd .; cd clacks.dbus &amp;&amp; ./setup.py develop; popd</pre>
</div>
<p>inside your activated virtual env. You can skip this if you ran ./setup.py for
a complete deployment.</p>
</div>
<div class="section" id="joining-the-party">
<h4>Joining the party<a class="headerlink" href="#joining-the-party" title="Permalink to this headline">¶</a></h4>
<p>A client needs to authenticate to the clacks bus. In order to create the required
credentials for that, you&#8217;ve to &#8220;announce&#8221; or &#8220;join&#8221; the client to the system.</p>
<p>To do that, run</p>
<div class="highlight-python"><pre>$ sudo -s
# cd 'wherever your clacks virtual environment is'
# source bin/activate
# clacks-join</pre>
</div>
<p>on the client you&#8217;re going to join. In the development case, this may be the
same machine which runs the agent.</p>
</div>
<div class="section" id="running-the-root-component">
<h4>Running the root component<a class="headerlink" href="#running-the-root-component" title="Permalink to this headline">¶</a></h4>
<p>Some functionality may need root permission, while we don&#8217;t want to run the complete
client as root. The clacks-dbus component is used to run dedicated tasks as root. It
can be extended by simple plugins and registers the resulting methods in the dbus
interface.</p>
<p>To use the dbus-component, you&#8217;ve to allow the clacks system user (or whatever user
the clacks-client is running later on) to use certain dbus services. Copy and eventually
adapt the file src/contrib/dbus/org.clacks.conf to /etc/dbus-1/system.d/ and
reload your dbus service.</p>
<div class="highlight-python"><pre>$ sudo service dbus reload</pre>
</div>
<p>To start the dbus component, activate the python virtual environment as root and run
the clacks-dbus component in daemon or foreground mode:</p>
<div class="highlight-python"><pre>$ sudo -s
# cd 'wherever your clacks virtual environment is'
# source bin/activate
# clacks-dbus</pre>
</div>
</div>
<div class="section" id="running-the-client">
<h4>Running the client<a class="headerlink" href="#running-the-client" title="Permalink to this headline">¶</a></h4>
<p>To run the client, you should put your development user into the clacks group - to
be able to use the dbus features:</p>
<div class="highlight-python"><pre>$ sudo adduser $USER clacks</pre>
</div>
<p>You might need to re-login to make the changes happen. After that, start the clacks
client inside the activated virtual environment:</p>
<div class="highlight-python"><pre>$ clacks-client</pre>
</div>
</div>
</div>
</div>
<div class="section" id="common-configuration">
<h2>Common configuration<a class="headerlink" href="#common-configuration" title="Permalink to this headline">¶</a></h2>
<div class="section" id="configuring-access-control">
<span id="setting-up-acl"></span><h3>Configuring access control<a class="headerlink" href="#configuring-access-control" title="Permalink to this headline">¶</a></h3>
<p>Because the Clacks framework supports various backends, it does access control of its
own. In order to do something reasonable with the framework, you&#8217;ve either to override
the access control (like done with the <em>admin</em> user), or you can apply fine grained
ACL rules and roles to your directory tree.</p>
<p>On the command line, you can use the <em>acl-admin</em> tool to manage the ACL system. It uses
the service discovery feature and asks for a username and password if it finds a service.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>You can override the service discovery by issuing:</p>
<div class="last highlight-python"><pre>$ acl-admin --user agent --password secret --url https://agent.example.net:8080/rpc</pre>
</div>
</div>
<p>The <em>acl-admin</em> is in development. Currently, you need to fire one subcommand per call,
which makes it a bit unconfortable for the first time. Here are a couple of ACLs and
roles that make sense:</p>
<div class="highlight-python"><pre># Allow clients to send certain events
add role dc=example,dc=net Clients
add roleacl with-actions name=Clients,dc=example,dc=net 0 psub "^net\.example\.command\.core\.(getMethods|sendEvent):x"
add roleacl with-actions name=Clients,dc=example,dc=net 0 psub "^net\.example\.event\.(Inventory|ClientAnnounce|ClientLeave|ClientSignature|ClientPing|UserSession)$:x"
add acl with-role dc=example,dc=net 0 '^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$' Clients

# Create GUI ACL role that allows login to a GUI
add role "dc=example,dc=net" GUI
add roleacl with-actions name=GUI,dc=example,dc=net 0 sub "^net\.example\.command\.core\.(getSessionUser|getBase|search):x"
add roleacl with-actions name=GUI,dc=example,dc=net 0 sub "^net\.example\.command\.gosa\..*:x"

# Create SelfService role that allows occupants to modify some of their attributes
add role "dc=example,dc=net" SelfService
add roleacl with-actions name=SelfService,dc=example,dc=net 0 sub "^net\.example\.command\.core\.(openObject|dispatchObjectMethod|setObjectProperty|closeObject):x"
add roleacl with-actions name=SelfService,dc=example,dc=net 0 sub "^net\.example\.command\.password\.(listPasswordMethods|accountLockable|accountUnlockable):x"
add roleacl with-actions name=SelfService,dc=example,dc=net 0 sub "^net\.example\.command\.objects\.(User|PosixUser|SambaUser|ShadowUser):crowdsexm"

# Create Administrative role - everything is allowed
add role "dc=example,dc=net" Administrators
add roleacl with-actions name=Administrators,dc=example,dc=net -100 psub "^net\.example\..*:crwdsex"

# Assign user 'ruth' the role 'Administrators'
add acl with-role dc=example,dc=net -100 ruth Administrators

# Assign user 'foobar' the SelfService and GUI role
add acl with-role dc=example,dc=net 0 foobar SelfService
add acl with-role dc=example,dc=net 0 foobar GUI</pre>
</div>
</div>
<div class="section" id="configuring-an-ldap-update-hook">
<h3>Configuring an LDAP update hook<a class="headerlink" href="#configuring-an-ldap-update-hook" title="Permalink to this headline">¶</a></h3>
<p>Maintaining and index of our own has several advantages: better search capabilities than
LDAP has, faster, proper sorted subset queries, etc. Nevertheless maintaining and index
has the disadvantage that modifications that happen to our backends don&#8217;t find their way
to the index at all.</p>
<p>For LDAP, there&#8217;s a tool called <em>clacks-ldap-monitor</em> in the tools directory. It uses the
same configuration like the agent does and needs to be started in the background - or by
the <em>supervisord</em>.</p>
<p>If you use it, please add a section to the Clacks configuration:</p>
<div class="highlight-python"><pre>[backend-monitor]
modifier = cn=agent,dc=example,dc=net
audit-log = /var/log/ldap-audit.log</pre>
</div>
<p>These are key descriptions:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="86%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Key</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>modifier</td>
<td>Account that does modifications in the LDAP in behalf of the clacks-agent.</td>
</tr>
<tr class="row-odd"><td>audit-log</td>
<td>LDAP auditlog</td>
</tr>
</tbody>
</table>
<p>In your OpenLDAP configuration you need to load the <em>auditlog</em> overlay and configure it
to log to <em>/var/log/ldap-audit.log</em>.</p>
</div>
</div>
</div>


        </div>
      </div>
      <div class="clearer"></div>
    </div>

    <div class="footer">
        &copy; Copyright 2012, GONICUS GmbH.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>